<html>
<head>
<title>О чем говорит twitter</title>
<meta charset="UTF-8">
<style>

.groups-table {
    border-collapse: collapse;
}
td, th {
    border: 2px solid rgb(218,218,218);
    vertical-align: top;
    padding: 5px;
} 

</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="/js/handlebars-v1.3.0.js"></script>
<script>
function clusterToStr(cluster) {
    var mems = cluster["members"];
    var str = "<p>" + cluster["avg_dist"] + "</p>";
    var mems_text = [];
    for(var i=0; i < mems.length; i++) {
        str += "<a href=\"./" + mems[i]["id"] + ".html\">" + mems[i]["text"] + "</a></br>";
        mems_text.push(mems[i]["text"]);
    }
    var time_query = "&tbs=cdr%3A1%2Ccd_min%3A14.04.2014%2Ccd_max%3A14.04.2014";
    var google_search = "https://www.google.ru/search?q=" + mems_text.join("+") + time_query;
    str += "<p><a href=\"" + google_search + "\">Искать в google<a/>"; 
    return str;
}
function getCurUrlParams() {
    var cur_url = "" + document.URL;
    var url_parts = cur_url.split("?");
    
    var params = {};
    if (url_parts.length > 1) {
        var param_parts = url_parts[1].split("&");
        for(var i =0 ; i< param_parts.length; i++) {
            var p = param_parts[i].split("=");
            params[p[0]] = p[1];
        }
    }
    
    return params;
}

function loadClusters(parse_url_args) {
    var k;
    var _date;
    if (parse_url_args) {
        k = getCurUrlParams()["k"];
        _date = getCurUrlParams()["date"];
    } else {
        k = parseInt($("#k-param").val());
        _date = parseInt($("#date-param").val());
    }
 
    console.log("loadClusters");
    $.get( "/api/cluster?k=" + k + "&date=" + _date, function( data ) {
        try{
        var cl = JSON.parse(data);
    
        cl.sort(function(a,b) {
            if (a["avg_dist"] < b["avg_dist"]) return -1;
            if (a["avg_dist"] > b["avg_dist"]) return 1;
            return 0;
        });

        var groups = [];
        var per_group = 8;
        while(cl.length > 0) {
            if (cl.length < per_group) {
                groups.push(cl);
                break;
            }
            groups.push(cl.slice(0, per_group));
            cl = cl.slice(per_group);
        }
        var cl_code = "<table class=\"groups-table\">";
        for(var i=0; i<groups.length; i++) {
            var row_str = "<tr>";
            for(var j=0; j<groups[i].length; j++) {
                var cell_str = "<td>" + clusterToStr(groups[i][j]) + "</td>";
                row_str += cell_str;
            }
            row_str += "</tr>"
            cl_code += row_str
        }
        cl_code += "</table>"
        $( "#cluster-holder" ).html( cl_code );
        } catch (e){
            console.log(e);
        }
    });
}
</script>

<script id="dates-template" type="text/x-handlebars-template">
    {{#each dates_available}}
    <a href="/clusters.html?k=100&date={{this}}">{{this}}</a>
    {{/each}}
</script>
</head>
<body onLoad="loadClusters(true)">
<h3>О чем говорили в русском твиттере 14 апреля</h3>
<p>
Каждая ячейка - это смысловая группа. Цифра в ячейке - это плотность группы, она показывает насколько похожи слова друг на друга. 
Чем ближе к 0, тем группа плотнее и слова более похожи.
Чем ближе к 1, тем разреженнее и сходство слов слабее.<br/>
В каждой ячейке есть ссылка - поискать слова из группы в Google.
</p>
<p>
<div id="available-dates"></div>
<script>
$.get( "/api/dates_available", function( data ) {
    try{
        var dates = JSON.parse(data);

        var source = $("#dates-template").html();
        var template = Handlebars.compile(source);
         
        $( "#available-dates" ).html( template(dates) );
    } catch(e) {
        console.log(e);
    }
})

</script>
</p>
<p>Чтобы сгенирорвать заново, нажми кнопку: </p>
<p>
Количество групп: <input type="text" id="k-param" value="100"/> <br/>
День: <input type="text" id="date-param" value=""/> <br/>
<button type="button" onClick="loadClusters()">Сгенерировать</button><br/>
</p>
<div id="cluster-holder"></div>
</body>
</html>
